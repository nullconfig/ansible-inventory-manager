<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ APP_TITLE || "Ansible Inventory UI" }}</title>
  <style>
    :root {
      --primary-color: {{ PRIMARY_COLOR || "#2563eb" }};
      --secondary-color: {{ SECONDARY_COLOR || "#4b5563" }};
      --bg-color: {{ BG_COLOR || "#f9fafb" }};
      --border-color: {{ BORDER_COLOR || "#e5e7eb" }};
      --selected-bg: {{ SELECTED_BG || "#dbeafe" }};
      --table-header-bg: {{ TABLE_HEADER_BG || "#f3f4f6" }};
      --table-border: {{ TABLE_BORDER || "#d1d5db" }};
    }

    body {
      margin: 0;
      font-family: {{ FONT_FAMILY || "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif" }};
      background-color: var(--bg-color);
    }

    * {
      box-sizing: border-box;
    }
    
    /* Add additional custom styles here */
    {{ CUSTOM_CSS || "" }}
  </style>
  
  <!-- External dependencies -->
  <script src={{ REACT_URL || "https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js" }}></script>
  <script src={{ REACT_DOM_URL || "https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js" }}></script>
  <script src={{ BABEL_URL || "https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.4/babel.min.js" }}></script>
  
  <!-- COMPONENTS_BUNDLE_PLACEHOLDER -->
</head>
<body>
  <div id="root"></div>

  <!-- Configuration -->
  <script>
    // Environment configuration - can be replaced with environment-specific values
    window.CONFIG = {
      API_ENDPOINT: {{ API_ENDPOINT || '"/api/inventory"' }},
      DEFAULT_EXPANDED: {{ DEFAULT_EXPANDED || false }},
      ENABLE_EDIT: {{ ENABLE_EDIT || false }},
      ENABLE_DELETE: {{ ENABLE_DELETE || false }},
      ENABLE_CREATE: {{ ENABLE_CREATE || false }},
      DEBUG_MODE: {{ DEBUG_MODE || false }},
      ICONS: {
        FOLDER: {{ FOLDER_ICON || '"folder"' }},
        SERVER: {{ SERVER_ICON || '"server"' }},
        CHEVRON_RIGHT: {{ CHEVRON_RIGHT_ICON || '"chevron-right"' }},
        CHEVRON_DOWN: {{ CHEVRON_DOWN_ICON || '"chevron-down"' }}
      }
    };
    
    // Enable debug output to help troubleshoot
    console.log("CONFIG loaded:", window.CONFIG);
  </script>

  <!-- Core application script -->
  <script type="text/babel">
    // Icon components with configurable options
    const icons = {
      "chevron-right": () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" 
             stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="m9 18 6-6-6-6"/>
        </svg>
      ),
      "chevron-down": () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" 
             stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="m6 9 6 6 6-6"/>
        </svg>
      ),
      "folder": () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" 
             stroke="var(--primary-color)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/>
        </svg>
      ),
      "server": () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" 
             stroke="var(--secondary-color)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/>
          <line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/>
        </svg>
      )
    };

    try {
      // Icon component that renders the appropriate icon based on name
      const Icon = ({ name }) => {
        try {
          const iconName = window.CONFIG.ICONS[name] || name;
          const IconComponent = icons[iconName] || (() => null);
          return <IconComponent />;
        } catch (err) {
          console.error("Error rendering icon:", err);
          return null;
        }
      };

      function App() {
        console.log("App component rendering");
        const [inventoryData, setInventoryData] = React.useState(null);
        const [selectedItem, setSelectedItem] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [expandedNodes, setExpandedNodes] = React.useState({});

        // Base styles that can be overridden via CSS variables
        const styles = {
          container: {
            display: 'flex',
            height: '100vh',
            backgroundColor: 'var(--bg-color)'
          },
          leftPanel: {
            width: '33.333333%',
            borderRight: '1px solid var(--border-color)',
            overflow: 'auto',
            padding: '1rem'
          },
          rightPanel: {
            width: '66.666667%',
            padding: '1rem',
            overflow: 'auto'
          },
          heading: {
            fontSize: '1.25rem',
            fontWeight: 'bold',
            marginBottom: '1rem'
          },
          treeContainer: {
            backgroundColor: 'white',
            borderRadius: '0.25rem',
            boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
          },
          treeNode: {
            display: 'flex',
            alignItems: 'center',
            padding: '0.5rem',
            cursor: 'pointer'
          },
          treeNodeSelected: {
            backgroundColor: 'var(--selected-bg)'
          },
          iconContainer: {
            marginRight: '0.25rem',
            cursor: 'pointer'
          },
          iconSpacer: {
            width: '1rem',
            marginRight: '0.25rem'
          },
          nameText: {
            marginLeft: '0.5rem'
          },
          childContainer: {
            marginLeft: '0.5rem'
          },
          detailsContainer: {
            backgroundColor: 'white',
            padding: '1rem',
            borderRadius: '0.25rem',
            boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
          },
          sectionTitle: {
            fontSize: '1.125rem',
            fontWeight: '600',
            marginBottom: '0.5rem',
            marginTop: '1rem'
          },
          detailsGrid: {
            display: 'grid',
            gridTemplateColumns: '1fr 1fr',
            gap: '0.5rem'
          },
          labelText: {
            color: 'var(--secondary-color)'
          },
          table: {
            width: '100%',
            borderCollapse: 'collapse'
          },
          tableHeader: {
            textAlign: 'left',
            padding: '0.5rem',
            backgroundColor: 'var(--table-header-bg)',
            border: '1px solid var(--table-border)'
          },
          tableCell: {
            padding: '0.5rem',
            border: '1px solid var(--table-border)',
            fontFamily: 'monospace',
            fontSize: '0.875rem'
          },
          itemsList: {
            listStyleType: 'disc',
            paddingLeft: '1.25rem'
          },
          linkItem: {
            color: 'var(--primary-color)',
            cursor: 'pointer',
            textDecoration: 'underline'
          },
          emptyMessage: {
            fontStyle: 'italic',
            color: 'var(--secondary-color)'
          },
          emptyStateMessage: {
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            height: '100%',
            color: 'var(--secondary-color)'
          },
          editControls: {
            display: window.CONFIG.ENABLE_EDIT ? 'flex' : 'none',
            marginTop: '1rem',
            gap: '0.5rem'
          },
          button: {
            padding: '0.5rem 1rem',
            backgroundColor: 'var(--primary-color)',
            color: 'white',
            border: 'none',
            borderRadius: '0.25rem',
            cursor: 'pointer'
          },
          dangerButton: {
            backgroundColor: '#dc2626',
          },
          // Additional styles for variable editing UI
          input: {
            width: '100%',
            padding: '0.375rem',
            border: '1px solid var(--border-color)',
            borderRadius: '0.25rem',
            fontFamily: 'inherit',
            fontSize: '0.875rem'
          },
          inputCell: {
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between'
          },
          smallButton: {
            padding: '0.25rem 0.5rem',
            backgroundColor: 'var(--primary-color)',
            color: 'white',
            border: 'none',
            borderRadius: '0.25rem',
            cursor: 'pointer',
            fontSize: '0.75rem',
            marginRight: '0.25rem'
          },
          saveButton: {
            backgroundColor: '#10b981' // Green
          },
          cancelButton: {
            backgroundColor: '#6b7280' // Gray
          },
          actionButtons: {
            display: 'flex',
            justifyContent: 'flex-start',
            gap: '0.25rem'
          }
        };

        // Fetch inventory data when component mounts
        React.useEffect(() => {
        console.log("useEffect running, fetching data");
        
        const fetchData = async () => {
            try {
            if (window.CONFIG.DEBUG_MODE) {
                console.log("Fetching from API endpoint:", window.CONFIG.API_ENDPOINT);
            }
            
            const response = await fetch(`${window.CONFIG.API_ENDPOINT}/inventory`);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            const data = await response.json();
            if (window.CONFIG.DEBUG_MODE) {
                console.log("Fetched data:", data);
            }
            
            setInventoryData(data);
            setLoading(false);
            
            // Expand nodes if configured to do so by default
            if (window.CONFIG.DEFAULT_EXPANDED && data && data.groups) {
                const expandedState = {};
                data.groups.forEach(group => {
                expandedState[group._id] = true;
                });
                setExpandedNodes(expandedState);
            }
            } catch (err) {
            console.error("Error fetching inventory:", err);
            setError(`Failed to fetch inventory data: ${err.message}. Please check that the backend service is running and MongoDB is accessible.`);
            setLoading(false);
            }
        };
        
        fetchData();
        }, []);

        // Toggle expanded state of a node
        const toggleExpand = (id) => {
          setExpandedNodes(prev => ({
            ...prev,
            [id]: !prev[id]
          }));
        };

        // Recursive function to build the tree view
        const renderTreeNode = (item, hostVars, level = 0) => {
          const hasChildren = item.children && item.children.length > 0;
          const hasHosts = item.hosts && item.hosts.length > 0;
          const isExpanded = expandedNodes[item._id];
          const isSelected = selectedItem && selectedItem._id === item._id;
          
          // Calculate padding based on level
          const paddingLeft = `${level * 16 + 8}px`;
          
          return (
            <div key={item._id} style={{ display: 'flex', flexDirection: 'column' }}>
              <div 
                style={{
                  ...styles.treeNode,
                  paddingLeft,
                  ...(isSelected ? styles.treeNodeSelected : {})
                }}
                onClick={() => setSelectedItem({...item, hostVars: hostVars})}
              >
                {(hasChildren || hasHosts) ? (
                  <div 
                    style={styles.iconContainer}
                    onClick={(e) => {
                      e.stopPropagation();
                      toggleExpand(item._id);
                    }}
                  >
                    {isExpanded ? <Icon name="CHEVRON_DOWN" /> : <Icon name="CHEVRON_RIGHT" />}
                  </div>
                ) : (
                  <div style={styles.iconSpacer}></div>
                )}
                
                {!item.type || item.type === 'group' ? 
                  <Icon name="FOLDER" /> : 
                  <Icon name="SERVER" />}
                
                <span style={styles.nameText}>{item.name}</span>
              </div>
              
              {isExpanded && (
                <div style={styles.childContainer}>
                  {/* Render child groups first */}
                  {hasChildren && item.children.map(childId => {
                    // Find the child group by ID
                    const childGroup = inventoryData.groups.find(g => g._id === childId);
                    if (childGroup) {
                      return renderTreeNode(childGroup, hostVars, level + 1);
                    }
                    return null;
                  })}
                  
                  {/* Then render hosts */}
                  {hasHosts && item.hosts.map(hostId => {
                    const hostData = {
                      _id: hostId,
                      name: hostId,
                      type: 'host',
                      vars: hostVars[hostId] || {}
                    };
                    return renderTreeNode(hostData, hostVars, level + 1);
                  })}
                </div>
              )}
            </div>
          );
        };

        // Helper function for demo editing capability
        const handleEdit = () => {
          if (window.CONFIG.DEBUG_MODE) {
            console.log("Edit clicked for item:", selectedItem);
          }
          alert("Edit functionality would be implemented here");
        };
        
        // Helper function for demo deletion capability
        const handleDelete = () => {
          if (window.CONFIG.DEBUG_MODE) {
            console.log("Delete clicked for item:", selectedItem);
          }
          if (confirm(`Are you sure you want to delete ${selectedItem.name}?`)) {
            alert("Delete functionality would be implemented here");
          }
        };

        // Render item details in the right panel
        const renderItemDetails = (item) => {
          if (!item) return null;
          
          // Check if it's a host or a group
          const isHost = item.type === 'host';
          
          return (
            <div style={styles.detailsContainer}>
              <h2 style={{ fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '1rem' }}>{item.name}</h2>
              
              <div style={{ marginBottom: '1rem' }}>
                <h3 style={styles.sectionTitle}>Basic Information</h3>
                <div style={styles.detailsGrid}>
                  <div style={styles.labelText}>Type:</div>
                  <div>{isHost ? 'Host' : 'Group'}</div>
                  <div style={styles.labelText}>ID:</div>
                  <div>{item._id}</div>
                </div>
              </div>
              
              <div style={{ marginBottom: '1rem' }}>
                <h3 style={styles.sectionTitle}>Variables</h3>
                {/* Use the imported VariablesTable component if available, otherwise fallback */}
                {typeof Components !== 'undefined' && Components.VariablesTable ? (
                  <Components.VariablesTable 
                    variables={item.vars} 
                    itemId={item._id} 
                    itemType={isHost ? 'host' : 'group'} 
                    styles={styles}
                  />
                ) : (
                  <div style={styles.emptyMessage}>
                    Variables table component not loaded. Check console for errors.
                  </div>
                )}
              </div>
              
              {!isHost && item.children && item.children.length > 0 && (
                <div style={{ marginBottom: '1rem' }}>
                  <h3 style={styles.sectionTitle}>Child Groups</h3>
                  <ul style={styles.itemsList}>
                    {item.children.map(childId => {
                      // Find the actual child group object
                      const childGroup = inventoryData.groups.find(g => g._id === childId);
                      return (
                        <li key={childId} 
                            style={styles.linkItem}
                            onClick={() => setSelectedItem({...childGroup, hostVars: item.hostVars})}>
                          {childGroup ? childGroup.name : childId}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              )}
              
              {!isHost && item.hosts && item.hosts.length > 0 && (
                <div>
                  <h3 style={styles.sectionTitle}>Hosts</h3>
                  <ul style={styles.itemsList}>
                    {item.hosts.map(hostId => {
                      const hostVars = item.hostVars ? item.hostVars[hostId] : {};
                      return (
                        <li key={hostId} 
                            style={styles.linkItem}
                            onClick={() => setSelectedItem({
                              _id: hostId,
                              name: hostId,
                              type: 'host',
                              vars: hostVars
                            })}>
                          {hostId}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              )}
              
              {/* Edit controls - only shown if enabled in config */}
              <div style={styles.editControls}>
                <button 
                  style={styles.button}
                  onClick={handleEdit}>
                  Edit
                </button>
                <button 
                  style={{...styles.button, ...styles.dangerButton}}
                  onClick={handleDelete}>
                  Delete
                </button>
              </div>
            </div>
          );
        };

        // Mock data generator function for fallback
        const getMockData = () => {
          // Define groups
          const groups = [
            {
              _id: "production",
              name: "production",
              vars: {
                env: "prod",
                datacenter: "us-east-1",
                backup_schedule: "daily",
                retention_days: 30
              },
              children: ["webservers", "dbservers"],
              hosts: []
            },
            {
              _id: "staging",
              name: "staging",
              vars: {
                env: "staging",
                datacenter: "us-west-2",
                backup_schedule: "weekly"
              },
              children: ["staging_webservers"],
              hosts: []
            },
            {
              _id: "webservers",
              name: "webservers",
              vars: {
                http_port: 80,
                nginx_version: "1.18.0",
                enable_ssl: true,
                health_check_path: "/health"
              },
              hosts: ["web1.example.com", "web2.example.com"],
              children: []
            },
            {
              _id: "dbservers",
              name: "dbservers",
              vars: {
                postgres_version: "13",
                backup_enabled: true,
                replication_mode: "async",
                connection_limit: 100
              },
              hosts: ["db1.example.com", "db2.example.com"],
              children: []
            },
            {
              _id: "staging_webservers",
              name: "staging_webservers",
              vars: {
                http_port: 8080,
                nginx_version: "1.20.0",
                enable_debug: true
              },
              hosts: ["web-staging.example.com"],
              children: []
            }
          ];
          
          // Define host variables
          const hostVars = {
            "web1.example.com": {
              ansible_host: "192.168.1.101",
              ansible_user: "ansible",
              instance_type: "t3.medium",
              role: "application",
              deployment_group: "blue"
            },
            "web2.example.com": {
              ansible_host: "192.168.1.102",
              ansible_user: "ansible",
              instance_type: "t3.medium",
              role: "application",
              deployment_group: "green"
            },
            "db1.example.com": {
              ansible_host: "192.168.1.201",
              ansible_user: "ansible",
              instance_type: "r5.large",
              role: "primary",
              storage_size_gb: 500
            },
            "db2.example.com": {
              ansible_host: "192.168.1.202",
              ansible_user: "ansible",
              instance_type: "r5.large",
              role: "replica",
              storage_size_gb: 500
            },
            "web-staging.example.com": {
              ansible_host: "10.0.1.10",
              ansible_user: "deploy",
              instance_type: "t3.small",
              enable_debug_logging: true
            }
          };
          
          return {
            groups: groups,
            hostVars: hostVars
          };
        };

        // UI for creating new items - only shown if enabled in config
        const renderCreateUI = () => {
          if (!window.CONFIG.ENABLE_CREATE) return null;
          
          return (
            <div style={{ marginBottom: '1rem' }}>
              <button 
                style={styles.button}
                onClick={() => alert("Create functionality would be implemented here")}>
                + Create New
              </button>
            </div>
          );
        };

        // Loading state
        if (loading) {
          return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh' }}>
            Loading inventory data...
          </div>;
        }

        // Error state
        if (error) {
            // Use the ErrorDisplay component if available, otherwise use basic error display
            if (typeof Components !== 'undefined' && Components.ErrorDisplay) {
                return <Components.ErrorDisplay error={error} styles={styles} />;
            }
            
            // Fallback error display
            return (
                <div style={{ 
                display: 'flex', 
                flexDirection: 'column',
                alignItems: 'center', 
                justifyContent: 'center', 
                height: '100vh', 
                padding: '2rem',
                color: '#dc2626', 
                textAlign: 'center' 
                }}>
                <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '1rem' }}>
                    Connection Error
                </h1>
                <p style={{ marginBottom: '1.5rem', maxWidth: '700px' }}>{error}</p>
                <button 
                    style={{
                    backgroundColor: 'var(--primary-color)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '0.25rem',
                    padding: '0.5rem 1rem',
                    cursor: 'pointer'
                    }}
                    onClick={() => window.location.reload()}>
                    Reload Page
                </button>
                </div>
            );
        }
        // Main layout
        return (
          <div style={styles.container}>
            {/* Left sidebar with tree view */}
            <div style={styles.leftPanel}>
              <h1 style={styles.heading}>Ansible Inventory</h1>
              {renderCreateUI()}
              <div style={styles.treeContainer}>
                {inventoryData && inventoryData.groups && 
                  // Find top-level groups (no parent groups)
                  inventoryData.groups
                    .filter(group => !inventoryData.groups.some(g => 
                      g.children && g.children.includes(group._id)
                    ))
                    .map(item => renderTreeNode(item, inventoryData.hostVars))
                }
              </div>
            </div>
            
            {/* Right panel with details */}
            <div style={styles.rightPanel}>
              {selectedItem ? (
                renderItemDetails(selectedItem)
              ) : (
                <div style={styles.emptyStateMessage}>
                  Select an item from the inventory to view details
                </div>
              )}
            </div>
          </div>
        );
      }

      console.log("Rendering React app");
      // Render the App component to the DOM
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
      console.log("React app rendered");
    } catch (err) {
      console.error("Fatal error in React application:", err);
      document.getElementById('root').innerHTML = `
        <div style="color: red; padding: 20px; text-align: center;">
          <h1>Error Loading Application</h1>
          <p>${err.message}</p>
          <p>Check the browser console for more details.</p>
        </div>
      `;
    }
  </script>
</body>
</html>